{% extends 'blog/base.html' %}
{% load form_filters %}
{% block title %}{{ book.title }}{% endblock %}
{% block content %}
<div class="container my-4">
  <div class="row">
    <div class="col-md-4">
      <img src="{{ book.cover_image.url }}" class="img-fluid" alt="Cover">
    </div>
    <div class="col-md-8">
      <h2>{{ book.title }}</h2>
      <p><strong>Author:</strong> {{ book.author }}</p>
      <p>{{ book.description }}</p>
      <p>üëç {{ upvotes }} | üëé {{ downvotes }}</p>

      {% if user.is_authenticated %}
        <form method="post">{% csrf_token %}
          <button name="upvote" class="btn btn-success">üëç Like</button>
          <button name="downvote" class="btn btn-danger">üëé Dislike</button>
        </form>
        <hr>
        <h4>Write your own thoughts about this book:</h4>
        <form method="post" novalidate>
          {% csrf_token %}
          {% for field in form %}
          <div class="mb-3">
            <!--<label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>-->
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-chat-left-text"></i></span>
              {{ field }}
            </div>
            {% if field.errors %}
              <div class="text-danger small">{{ field.errors }}</div>
            {% endif %}
          </div>
          {% endfor %}
          <button type="submit" name="review_submit" class="btn btn-outline-primary mt-auto">Submit</button>
        </form>
      {% else %}
        <p><a href="{% url 'login' %}">Log in</a> to rate and comment on this book.</p>
      {% endif %}

      <hr>
      <h3>Comments:</h3>
      {% if comments %}
        {% for comment in comments %}
          {% if not comment.parent %}
          <div class="card mb-3">
            <div class="card-body">
              <p class="mb-1"><strong>{{ comment.user.username }}</strong></p>
              <p>{{ comment.text }}</p>
              <a href="#" class="reply-link" data-comment-id="{{ comment.id }}">Reply</a>
            </div>

            {% for reply in comment.replies.all %}
              {% if reply.approved %}
              <div class="card-body ms-4 border-start">
                <p class="mb-1 text-muted"><i class="bi bi-arrow-return-right"></i> <strong>{{ reply.user.username }}</strong></p>
                <p>{{ reply.text }}</p>
              </div>
              {% endif %}
            {% endfor %}
          </div>
          {% endif %}
        {% endfor %}

        <!--{% if messages %}
        <div class="container mt-3">
          {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
          {% endfor %}
        </div>
        {% endif %}-->

        <div id="reply-form-container" style="display: none;">
          <br/>
          <form method="post" id="reply-form">
            {% csrf_token %}
            {{ form.text|add_class:"form-control mb-2" }}
            <input type="hidden" name="parent_id" id="parent_id">
            <button type="submit" name="reply_submit" class="btn btn-sm btn-primary">Submit Reply</button>
          </form>
        </div>

        <script>
        document.addEventListener('DOMContentLoaded', () => {
          document.querySelectorAll('.reply-link').forEach(link => {
            link.addEventListener('click', function (e) {
              e.preventDefault();
              const commentId = this.getAttribute('data-comment-id');
              const form = document.getElementById('reply-form-container');
              const parentInput = document.getElementById('parent_id');
              parentInput.value = commentId;
              this.parentElement.appendChild(form);
              form.style.display = 'block';
            });
          });
        });
        </script>
      {% else %}
        <p>No comments yet.</p>
      {% endif %}
      <a href="{% url 'books' %}" class="btn btn-outline-primary mt-auto">Back to Books</a>
    </div>
  </div>
</div>
{% endblock %}
